#!/usr/sbin/nft -f
# /etc/nftables.conf
# Secure Development Environment Firewall Configuration

# Clear all existing rules
flush ruleset

# Main firewall table
table inet filter {
    # ===== INPUT CHAIN (Incoming Traffic) =====
    chain input {
        type filter hook input priority filter; policy drop;
        
        # Accept all loopback traffic
        iif lo accept comment "Accept loopback"
        
        # Accept established and related connections
        ct state established,related accept comment "Accept established connections"
        
        # Drop invalid packets
        ct state invalid drop comment "Drop invalid packets"
        
        # Allow ICMPv4
        ip protocol icmp accept comment "Accept ICMPv4"
        
        # Allow ICMPv6
        ip6 nexthdr ipv6-icmp accept comment "Accept ICMPv6"
        
        # Allow SSH with rate limiting
        tcp dport 22 ct state new limit rate 3/minute accept comment "SSH with rate limit"
        
        # Allow DHCP client
        udp sport 68 udp dport 67 accept comment "DHCP client"
        
        # Reject everything else
        reject with icmpx type port-unreachable
    }
    
    # ===== FORWARD CHAIN (Forwarded Traffic) =====
    chain forward {
        type filter hook forward priority filter; policy drop;
        
        # Accept Docker traffic if Docker is running
        iifname "docker0" accept comment "Docker outbound"
        oifname "docker0" ct state established,related accept comment "Docker inbound"
    }
    
    # ===== OUTPUT CHAIN (Outgoing Traffic) =====
    chain output {
        type filter hook output priority filter; policy accept;
        
        # Accept all loopback
        oif lo accept comment "Accept loopback output"
        
        # Accept established and related
        ct state established,related accept comment "Accept established output"
        
        # Allow DNS
        udp dport 53 accept comment "Allow DNS UDP"
        tcp dport 53 accept comment "Allow DNS TCP"
        
        # Allow HTTP/HTTPS
        tcp dport 80 accept comment "Allow HTTP"
        tcp dport 443 accept comment "Allow HTTPS"
        
        # Allow SSH outbound
        tcp dport 22 accept comment "Allow SSH outbound"
        
        # Allow NTP
        udp dport 123 accept comment "Allow NTP"
        
        # Allow WireGuard VPN
        udp dport 51820 accept comment "Allow WireGuard"
        
        # Allow Git protocol
        tcp dport 9418 accept comment "Allow Git protocol"
    }
}
