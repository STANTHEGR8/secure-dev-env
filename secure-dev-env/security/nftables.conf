#!/usr/sbin/nft -f
# /etc/nftables.conf
# Secure Development Environment Firewall

flush ruleset

# Define variables
define DEV_INTERFACE = eth0
define VPN_INTERFACE = wg0
define LOOPBACK = lo

table inet filter {
    # ===== INPUT CHAIN =====
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Accept loopback traffic
        iif $LOOPBACK accept
        
        # Accept established/related connections
        ct state established,related accept
        
        # Drop invalid packets
        ct state invalid drop
        
        # Allow ICMP (ping)
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept
        
        # Allow SSH with rate limiting (prevent brute force)
        tcp dport 22 ct state new limit rate 3/minute accept
        
        # Allow DHCP client
        udp sport 68 udp dport 67 accept
        udp sport 546 udp dport 547 accept  # DHCPv6
        
        # Log dropped packets (uncomment for debugging)
        # log prefix "INPUT DROP: " level info
        
        # Reject everything else with ICMP message
        reject with icmpx type port-unreachable
    }
    
    # ===== FORWARD CHAIN =====
    chain forward {
        type filter hook forward priority 0; policy drop;
        
        # Docker container forwarding (if Docker is used)
        iifname "docker0" accept
        oifname "docker0" ct state related,established accept
        
        # Log dropped forwards (uncomment for debugging)
        # log prefix "FORWARD DROP: " level info
    }
    
    # ===== OUTPUT CHAIN =====
    chain output {
        type filter hook output priority 0; policy accept;
        
        # Accept loopback
        oif $LOOPBACK accept
        
        # Accept established/related
        ct state established,related accept
        
        # Allow DNS
        udp dport 53 accept
        tcp dport 53 accept
        
        # Allow DNS-over-HTTPS (cloudflared)
        tcp dport 443 accept
        
        # Allow HTTP/HTTPS
        tcp dport 80 accept
        
        # Allow SSH outbound
        tcp dport 22 accept
        
        # Allow NTP
        udp dport 123 accept
        
        # Allow WireGuard VPN
        udp dport 51820 accept
        
        # Allow Git protocol
        tcp dport 9418 accept
        
        # Allow rsync
        tcp dport 873 accept
        
        # Drop everything else (uncomment for strict mode)
        # log prefix "OUTPUT DROP: " level info
        # drop
    }
}